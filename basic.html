<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<title>jQuery File Upload Demo - Basic version</title>
<link rel="stylesheet" href="css/jquery.Jcrop.css" type="text/css" />
</head>
<body>

<div class="container">

	<span class="btn btn-success fileinput-button">
		<!-- The file input field used as target for the file upload widget -->
		<form>
		   <input id="fileupload" type="file" name="files" >
		</form>
	</span>
	<br>
	<br>
	<!-- The global progress bar -->
	<div id="progress" class="progress">
		<div class="progress-bar progress-bar-success"></div>
	</div>
	<!-- The container for the uploaded files -->
	<div id="files" class="files"></div>
	<br>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="js/vendor/jquery.ui.widget.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="js/jquery.fileupload.js"></script>
<script src="js/jquery.Jcrop.js"></script>
<!-- Bootstrap JS is not required, but included for the responsive demo navigation -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script>
/*jslint unparam: true */
/*global window, $ */
$(function () {
	'use strict';
	// Change this to the location of your server-side upload handler:
	$('#fileupload').fileupload({
		url: 'server/php/',
		autoUpload: true,
		forceIframeTransport: true,
		dataType: 'json',
		done: function (e, data) {
			$.each(data.result.files, function (index, file) {
				$('#files').html('');
				$('#files').append('<img style="width: 400px;" src="'+file.url+'" id="jcrop_target" /><br /><br />');
				$('#files').append('<img style="display: none" src="'+file.url+'" id="jcrop_original" />');
				$('#files').append('<div id="preview_frame" style="height: 250px; width: 250px; overflow: hidden;"><img src="'+file.url+'" id="preview" /></div>');
				$('#files').append('<input type="submit" id="generate_thumb" />');
				$('#files').append('<div id="thumb"></div>');
				$('#generate_thumb').click(function() { buildThumb(file.url); });
				$('#jcrop_target').Jcrop({ onChange: showPreview, onSelect: showPreview, aspectRatio: 1, maxSize: [250,250], allowMove: true });
			});
		},
		progressall: function (e, data) {
			var progress = parseInt(data.loaded / data.total * 100, 10);
			$('#progress .progress-bar').css(
				'width',
				progress + '%'
			);
		}
	}).prop('disabled', !$.support.fileInput)
		.parent().addClass($.support.fileInput ? undefined : 'disabled');

});
var thumbnail_coords;
function buildThumb(image_url) {
	if(thumbnail_coords) {
		thumbnail_coords.url = image_url;
		console.log(thumbnail_coords);
		$.ajax({
			url: 'server/php/?resize=true',
			data: thumbnail_coords,
			success: function(data) {
				$('#thumb').html(data);
			}
		});
	}
}
function showPreview(coords)
{
	thumbnail_coords = coords;
	var rx = $('#preview_frame').width() / coords.w;
	var ry = $('#preview_frame').height() / coords.h;

	$('#preview').css({
		width: Math.round(rx * $('#jcrop_target').width()) + 'px',
		height: Math.round(ry * $('#jcrop_target').height()) + 'px',
		marginLeft: '-' + Math.round(rx * coords.x) + 'px',
		marginTop: '-' + Math.round(ry * coords.y) + 'px'
	}).show();
}
</script>
</body> 
</html>
